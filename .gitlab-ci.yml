stages:
  - Build
  - Push
  - Deploy

default:
  interruptible: true
  before_script:
    #ç™»å½•dockeråç»­æ¨é€é•œåƒ
    - docker login -u "${HARBOR_USER}" -p "${HARBOR_PWD}" ${HARBOR_HOST}
    #å¤§å†™è½¬æ¢ä¸ºå°å†™ï¼Œä¸ç„¶æ‰“åŒ…æŠ¥é”™
    - declare -l PROJECT_NAME=${CI_PROJECT_NAME}
    - export IMG="${HARBOR_HOST}/${HARBOR_NAMESPACE}/${PROJECT_NAME}:${CI_COMMIT_SHORT_SHA}-${CI_PIPELINE_ID}"
#ç¼“å­˜æ„å»ºç‰©ç»™ä¸‹ä¸ªé˜¶æ®µä½¿ç”¨
cache:
  paths:
    - dist/

package:dev:
  stage: Build
  interruptible: true
  script:
    - yarn --registry https://registry.npmmirror.com
    - yarn build
  tags:
    - shared
  only:
    - /dev/

package:test:
  stage: Build
  interruptible: true
  script:
    - yarn --registry https://registry.npmmirror.com
    - yarn build:test
  tags:
    - shared
  only:
    - /test/

package:prod:
  stage: Build
  interruptible: true
  script:
    - yarn --registry https://registry.npmmirror.com
    - yarn build:prod
  tags:
    - shared
  only:
    - /^v/

push:dev:
  stage: Push
  interruptible: true
  script:
    - docker build -t ${IMG}-dev .
    - docker push  ${IMG}-dev
    - docker rmi ${IMG}-dev
    - echo -e "\e[31m Docker image is here ğŸ‘‰ \e[0m" ${IMG}-dev
  tags:
    - shared
  only:
    - /dev/
  dependencies:
    - package:dev

push:test:
  stage: Push
  interruptible: true
  script:
    - docker build -t ${IMG}-test .
    - docker push  ${IMG}-test
    - docker rmi ${IMG}-test
    - echo -e "\e[31m Docker image is here ğŸ‘‰ \e[0m" ${IMG}-test
  tags:
    - shared
  only:
    - /test/
  dependencies:
    - package:test

push:prod:
  stage: Push
  interruptible: true
  script:
    - docker build -t ${IMG}-prod .
    - docker push  ${IMG}-prod
    - docker rmi ${IMG}-prod
    - echo -e "\e[31m Docker image is here ğŸ‘‰ \e[0m" ${IMG}-prod
  tags:
    - shared
  only:
    - /^v/
  dependencies:
    - package:prod

update:dev:
  stage: Deploy
  interruptible: true
  script:
    - curl -s -X POST --user ${JenkinsUser}:${JenkinsToken}
      http://10.23.243.182:18080/job/${PROJECT_NAME}/buildWithParameters
      --data-urlencode "IMAGE=${IMG}-dev"
      --data-urlencode "ENV=dev"
  tags:
    - shared
  only:
    - /dev/
  dependencies:
    - push:dev

update:test:
  stage: Deploy
  interruptible: true
  script:
    - curl -s -X POST --user ${JenkinsUser}:${JenkinsToken}
      http://10.23.243.182:18080/job/${PROJECT_NAME}/buildWithParameters
      --data-urlencode "IMAGE=${IMG}-test"
      --data-urlencode "ENV=test"
  tags:
    - shared
  only:
    - /test/
  dependencies:
    - push:test

update:prod:
  stage: Deploy
  interruptible: true
  script:
    - curl -s -X POST --user ${JenkinsUser}:${JenkinsToken}
      http://10.23.243.182:18080/job/${PROJECT_NAME}/buildWithParameters
      --data-urlencode "IMAGE=${IMG}-prod"
      --data-urlencode "ENV=prod"
  tags:
    - shared
  only:
    - /^v/
  dependencies:
    - push:prod
